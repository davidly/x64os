# x64os
Run AMD64 Linux elf binaries on Windows, Linux, MacOS on arbitrary ISAs.
Also, run x64 Linux elf binaries on Windows, Linux, MacOS on arbitrary ISAs.

The x64os emulator runs binaries built for an AMD64 Linux machine on other machines. 
The x32os emulator runs binaries built for an x86 Linux machine on other machines. 

Only a subset of the Linux syscalls are implemented including memory allocation and file I/O.

AMD64 emulation is limited to real-mode 64-bit long mode only. Integer, x87, and SSE2 instructions
are partially implemented. Other vector extensions including MMX and AVX are not implemented. The
only instructions implemented are those used by glibc and those generated by the gcc, clang, Rust,
and gfortran compilers at various optimization levels for the test cases that are part of this repo.

x64 emulation has similar limitations -- real-mode only and just the subset of instructions required
to run the test suite.

80-bit x87 floating point only works correctly when using GNU gcc (on Windows or Linux) and when
running on AMD64 hardware. Other compilers and platforms fall back to 64-bit long doubles. For most
long double floating point operations the impact is minimal, but for some seemingly innocuous code the
impact is catastrophic. In theory using Clang on AMD64 with x87 support should work too, but I hit 3 bugs with their
implamentation and gave up. Apps that don't use long double work fine with all compilers and platforms.

Files:

  * x64os.cxx + linuxem.h: Main app that loads ELF binaries and provides basic Linux syscall emulation
  * x64.cxx + x64.hxx: AMD64 and 32-bit x86 emulation
  * *.hxx: support functionality
  * m.bat, mr.bat, m32.bat m32r.bat: builds x64os and x32os for release and debug using msvc on Windows
  * mg.bat, mgr.bat, m32g.bat m32gr.bat: builds x64os and x32os for release and debug using gcc on Windows
  * m.sh, mr.sh, m32.sh m32r.sh: builds x64os and x32os for release and debug using gcc on Linux
  
Test folders:

  * c_tests: a variety of assembly and C test cases with scripts to build with gcc and clang at optimization levels 0, 1, 2, 3, and fast
  * f_tests: a varity of GNU Fortran test cases and scripts to build them
  * rust_tests: a varity of Rust test cases with scripts to build at optimization levels 0, 1, 2, and 3.

I've only validated x32os with the c_tests test cases, not Fortran or Rust.

In addition to the test cases above, all of the test cases were run in x64os built for Sparc v8, 68000,
Arm64, and RISC-V64 in emulators for each of those ISAs. Those can be found in sister repos sparcos, m68,
armos, and rvos. x64os was also tested recursively by running itself running each test case.

Also, each of the emulators mentioned above were built for AMD64 and run nested in x64os with all of their
respective test cases for validation.

Next steps:

   * Generate test cases that use instructions not yet implemented x64os can be more complete.
   * Performance pass. x64os runs test binaries about 2x slower than other emulators mentioned above run equivalent binaries due to decoding complexity.
